AWSTemplateFormatVersion: '2010-09-09'
Description: 'Security Essentials Compliance Conformance Pack for UK AWS Secure Landing Zone'

Parameters:
  FirewallTimeoutSeconds:
    Default: '300'
    Type: String
    Description: Timeout for firewall configuration checks
  
  PatchComplianceTimeoutDays:
    Default: '30'
    Type: String
    Description: Maximum days for patch compliance
  
  PasswordComplexityMinLength:
    Default: '14'
    Type: String
    Description: Minimum password length for Security Essentials compliance

Resources:
  # Security Essentials Control 1: Boundary Firewalls and Internet Gateways
  SecurityGroupSshRestrictedCheck:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-security-group-ssh-restricted-check
      Description: 'Security Essentials Control 1: Ensures security groups do not allow unrestricted SSH access'
      Source:
        Owner: AWS
        SourceIdentifier: INCOMING_SSH_DISABLED
      Scope:
        ComplianceResourceTypes:
          - AWS::EC2::SecurityGroup

  SecurityGroupRdpRestrictedCheck:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-security-group-rdp-restricted-check
      Description: 'Security Essentials Control 1: Ensures security groups do not allow unrestricted RDP access'
      Source:
        Owner: AWS
        SourceIdentifier: RESTRICTED_INCOMING_TRAFFIC
      InputParameters: |
        {
          "blockedPort1": "3389"
        }
      Scope:
        ComplianceResourceTypes:
          - AWS::EC2::SecurityGroup

  VpcDefaultSecurityGroupClosed:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-vpc-default-security-group-closed
      Description: 'Security Essentials Control 1: Ensures default security groups restrict all traffic'
      Source:
        Owner: AWS
        SourceIdentifier: VPC_DEFAULT_SECURITY_GROUP_CLOSED
      Scope:
        ComplianceResourceTypes:
          - AWS::EC2::SecurityGroup

  VpcFlowLogsEnabled:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-vpc-flow-logs-enabled
      Description: 'Security Essentials Control 1: Ensures VPC Flow Logs are enabled for network monitoring'
      Source:
        Owner: AWS
        SourceIdentifier: VPC_FLOW_LOGS_ENABLED
      Scope:
        ComplianceResourceTypes:
          - AWS::EC2::VPC

  # Security Essentials Control 2: Secure Configuration
  Ec2InstanceManagedBySsm:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-ec2-instance-managed-by-ssm
      Description: 'Security Essentials Control 2: Ensures EC2 instances are managed by Systems Manager for secure configuration'
      Source:
        Owner: AWS
        SourceIdentifier: EC2_INSTANCE_MANAGED_BY_SSM
      Scope:
        ComplianceResourceTypes:
          - AWS::EC2::Instance

  Ec2SecurityGroupAttachedToEni:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-ec2-security-group-attached-to-eni
      Description: 'Security Essentials Control 2: Ensures security groups are attached to network interfaces'
      Source:
        Owner: AWS
        SourceIdentifier: EC2_SECURITY_GROUP_ATTACHED_TO_ENI
      Scope:
        ComplianceResourceTypes:
          - AWS::EC2::SecurityGroup

  IamPasswordPolicy:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-iam-password-policy
      Description: 'Security Essentials Control 2: Ensures strong password policy is configured'
      Source:
        Owner: AWS
        SourceIdentifier: IAM_PASSWORD_POLICY
      InputParameters: !Sub |
        {
          "RequireUppercaseCharacters": "true",
          "RequireLowercaseCharacters": "true",
          "RequireNumbers": "true",
          "RequireSymbols": "true",
          "MinimumPasswordLength": "${PasswordComplexityMinLength}",
          "PasswordReusePrevention": "24",
          "MaxPasswordAge": "90"
        }

  S3BucketPublicAccessProhibited:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-s3-bucket-public-access-prohibited
      Description: 'Security Essentials Control 2: Ensures S3 buckets do not allow public access'
      Source:
        Owner: AWS
        SourceIdentifier: S3_BUCKET_PUBLIC_ACCESS_PROHIBITED
      Scope:
        ComplianceResourceTypes:
          - AWS::S3::Bucket

  # Security Essentials Control 3: Access Control
  IamUserMfaEnabled:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-iam-user-mfa-enabled
      Description: 'Security Essentials Control 3: Ensures IAM users have MFA enabled'
      Source:
        Owner: AWS
        SourceIdentifier: IAM_USER_MFA_ENABLED

  RootUserMfaEnabled:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-root-user-mfa-enabled
      Description: 'Security Essentials Control 3: Ensures root user has MFA enabled'
      Source:
        Owner: AWS
        SourceIdentifier: ROOT_USER_MFA_ENABLED

  IamPolicyNoStatementsWithAdminAccess:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-iam-policy-no-statements-with-admin-access
      Description: 'Security Essentials Control 3: Ensures IAM policies do not grant administrative access unnecessarily'
      Source:
        Owner: AWS
        SourceIdentifier: IAM_POLICY_NO_STATEMENTS_WITH_ADMIN_ACCESS
      Scope:
        ComplianceResourceTypes:
          - AWS::IAM::Policy

  AccessKeysRotated:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-access-keys-rotated
      Description: 'Security Essentials Control 3: Ensures access keys are rotated regularly'
      Source:
        Owner: AWS
        SourceIdentifier: ACCESS_KEYS_ROTATED
      InputParameters: |
        {
          "maxAccessKeyAge": "90"
        }

  IamUserUnusedCredentialsCheck:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-iam-user-unused-credentials-check
      Description: 'Security Essentials Control 3: Ensures unused IAM credentials are identified and removed'
      Source:
        Owner: AWS
        SourceIdentifier: IAM_USER_UNUSED_CREDENTIALS_CHECK
      InputParameters: |
        {
          "maxCredentialUsageAge": "90"
        }

  # Security Essentials Control 4: Malware Protection
  GuarddutyEnabledCentralized:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-guardduty-enabled-centralized
      Description: 'Security Essentials Control 4: Ensures GuardDuty is enabled for malware detection'
      Source:
        Owner: AWS
        SourceIdentifier: GUARDDUTY_ENABLED_CENTRALIZED

  Ec2InstanceDetailedMonitoringEnabled:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-ec2-instance-detailed-monitoring-enabled
      Description: 'Security Essentials Control 4: Ensures EC2 instances have detailed monitoring for anomaly detection'
      Source:
        Owner: AWS
        SourceIdentifier: EC2_INSTANCE_DETAILED_MONITORING_ENABLED
      Scope:
        ComplianceResourceTypes:
          - AWS::EC2::Instance

  # Security Essentials Control 5: Patch Management
  Ec2ManagedInstanceAssociationComplianceStatusCheck:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-ec2-managedinstance-association-compliance-status-check
      Description: 'Security Essentials Control 5: Ensures EC2 instances are compliant with patch management associations'
      Source:
        Owner: AWS
        SourceIdentifier: EC2_MANAGEDINSTANCE_ASSOCIATION_COMPLIANCE_STATUS_CHECK
      Scope:
        ComplianceResourceTypes:
          - AWS::SSM::AssociationCompliance

  Ec2ManagedInstancePatchComplianceStatusCheck:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-ec2-managedinstance-patch-compliance-status-check
      Description: 'Security Essentials Control 5: Ensures EC2 instances are compliant with patch management'
      Source:
        Owner: AWS
        SourceIdentifier: EC2_MANAGEDINSTANCE_PATCH_COMPLIANCE_STATUS_CHECK
      Scope:
        ComplianceResourceTypes:
          - AWS::SSM::PatchCompliance

  # Additional Security Controls
  CloudtrailEnabled:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-cloudtrail-enabled
      Description: 'Security Essentials: Ensures CloudTrail is enabled for audit logging'
      Source:
        Owner: AWS
        SourceIdentifier: CLOUD_TRAIL_ENABLED

  CloudtrailLogFileValidationEnabled:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-cloudtrail-log-file-validation-enabled
      Description: 'Security Essentials: Ensures CloudTrail log file validation is enabled'
      Source:
        Owner: AWS
        SourceIdentifier: CLOUD_TRAIL_LOG_FILE_VALIDATION_ENABLED

  EncryptedVolumes:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-encrypted-volumes
      Description: 'Security Essentials: Ensures EBS volumes are encrypted'
      Source:
        Owner: AWS
        SourceIdentifier: ENCRYPTED_VOLUMES
      Scope:
        ComplianceResourceTypes:
          - AWS::EC2::Volume

  S3BucketServerSideEncryptionEnabled:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-s3-bucket-server-side-encryption-enabled
      Description: 'Security Essentials: Ensures S3 buckets have server-side encryption enabled'
      Source:
        Owner: AWS
        SourceIdentifier: S3_BUCKET_SERVER_SIDE_ENCRYPTION_ENABLED
      Scope:
        ComplianceResourceTypes:
          - AWS::S3::Bucket

  RdsStorageEncrypted:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-rds-storage-encrypted
      Description: 'Security Essentials: Ensures RDS instances have storage encryption enabled'
      Source:
        Owner: AWS
        SourceIdentifier: RDS_STORAGE_ENCRYPTED
      Scope:
        ComplianceResourceTypes:
          - AWS::RDS::DBInstance

  # Network Security
  ElbTlsHttpsListenersOnly:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-elb-tls-https-listeners-only
      Description: 'Security Essentials: Ensures ELB listeners use HTTPS/TLS only'
      Source:
        Owner: AWS
        SourceIdentifier: ELB_TLS_HTTPS_LISTENERS_ONLY
      Scope:
        ComplianceResourceTypes:
          - AWS::ElasticLoadBalancing::LoadBalancer

  AlbHttpToHttpsRedirectionCheck:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-alb-http-to-https-redirection-check
      Description: 'Security Essentials: Ensures ALB redirects HTTP to HTTPS'
      Source:
        Owner: AWS
        SourceIdentifier: ALB_HTTP_TO_HTTPS_REDIRECTION_CHECK
      Scope:
        ComplianceResourceTypes:
          - AWS::ElasticLoadBalancingV2::LoadBalancer

  # Resource Tagging for Asset Management
  RequiredTags:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: ce-required-tags
      Description: 'Security Essentials: Ensures resources have required tags for asset management'
      Source:
        Owner: AWS
        SourceIdentifier: REQUIRED_TAGS
      InputParameters: |
        {
          "tag1Key": "Environment",
          "tag2Key": "Owner",
          "tag3Key": "CriticalityLevel",
          "tag4Key": "PatchGroup"
        }
      Scope:
        ComplianceResourceTypes:
          - AWS::EC2::Instance
          - AWS::S3::Bucket
          - AWS::RDS::DBInstance
          - AWS::ElasticLoadBalancing::LoadBalancer